# Walkthrough: Using a Topic Inference on-chain

Follow these instructions to bring the most recent inference data on-chain for a given topic. 

## Complete Example:

```solidity
    /**
     * @notice Example for calling a protocol function with topic inference data
     * 
     * @param protocolFunctionArgument An argument for the protocol function
     * @param alloraNetworkInferenceData The signed data from the Allora Consumer
     */
    function callProtocolFunctionWithAlloraTopicInference(
        uint256 protocolFunctionArgument,
        AlloraConsumerNetworkInferenceData calldata alloraNetworkInferenceData
    ) external payable {
        (
            uint256 value,
            uint256[] memory confidenceIntervalPercentiles,
            uint256[] memory confidenceIntervalValues,
        ) = IAlloraConsumer(<Consumer Contract Address>).verifyNetworkInference(alloraNetworkInferenceData);

        _protocolFunctionRequiringPredictionValue(
            protocolFunctionArgument, 
            value,
            confidenceIntervalPercentiles,
            confidenceIntervalValues
        );
    }
```

## Step by Step Guide:

1. Create an Upshot API key by [creating an account](https://developer.upshot.xyz/signup).
2. Call the Consumer Inference API using the `topicId` found in the [deployed topics list](./existing-topics) and the correct chainId. For example, if you use sepolia, you would provide `ethereum-11155111`.

```shell
curl -X 'GET' --url 'https://api.upshot.xyz/v2/allora/consumer/<chainId>?allora_topic_id=<topicId>' -H 'accept: application/json' -H 'x-api-key: <apiKey>'
```

Here is an example response: 
```json
{
    "request_id": "409de397-99f8-4911-91ed-74e6fe748115",
    "status": true,
    "data": {
        "signature": "0x8165fff89ca07fadff3f4e27b200bd3eae2132055aa8f0a224832446505c0662033b3038c9694000af60d4e9fbf8504cd9729b9841db286f45070a9c92f2531d1c",
        "inference_data": {
            "network_inference": "61022689135670660000000",
            "confidence_interval_percentiles": [],
            "confidence_interval_values": [],
            "topic_id": "11",
            "timestamp": 1719688595,
            "extra_data": "0x"
        }
    }
}
```


3. Construct a call to the Allora Consumer contract on the chain of your choice (options listed under [deployments](./existing-consumers)) using the returned `signature` and `network-inference` as follows:

## Creating the Transaction:

Note you be doing something more like `callProtocolFunctionWithAlloraTopicInference` in the example above, so you would want to construct your call to that contract in a similar way to the following:

```typescript
await alloraConsumer.verifyNetworkInference({  
  signature: signature,  
  networkInference: {
    networkInference: networkInference,
    confidenceIntervalPercentiles: confidenceIntervalPercentiles,
    confidenceIntervalValues: confidenceIntervalValues,
    timestamp: timestamp,
    topicId: topicId,
    extraData: '0x'
  },
  extraData: '0x'
})
```


## Notes

- The API endpoint uses `snake_case`, while the smart contract uses `camelCase` for attribute names.
- Ethers.js does not accept `''` for `extraData`. Empty `extraData` should be denoted with `'0x'`.

## Code Links

- [Open source consumer code](https://github.com/allora-network/allora-consumer/blob/main/src/)
- [IAlloraConsumer](https://github.com/allora-network/allora-consumer/blob/main/src/interface/IAlloraConsumer.sol), including the structs used for Solidity code.
